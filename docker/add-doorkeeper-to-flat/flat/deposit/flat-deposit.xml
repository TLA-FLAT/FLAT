<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns:flat="java:nl.mpi.tla.flat">
    <config>
        <import class="nl.mpi.tla.flat.deposit.context.Environment" prefix="env-"/>
        <import class="nl.mpi.tla.flat.deposit.context.SystemProperties" prefix="sys-"/>
        <property name="fitsService" value="http://localhost:8080/fits/" uniq="true"/>
        <property name="home" value="/app/flat" uniq="true"/>
        <property name="base" value="{$home}/deposit" uniq="true"/>
        <property name="bag" value="{$base}/bags/{$sip}" uniq="true"/>
        <property name="work" value="{flat:findBagBase($bag)}" uniq="true"/>
        <property name="easy" value="{$base}/easy" uniq="true"/>
        <property name="epicPrefix" value="12345"/>
        <property name="fedoraUser" value="fedoraAdmin"/>
        <property name="fedoraPassword" value="fedora"/>
        <property name="fedoraServer" value="https://localhost:8443/fedora"/>
        <property name="publicFedoraServer" value="http://localhost/flat"/>
        <property name="gsearchUser" value="fgsAdmin"/>
        <property name="gsearchPassword" value="fgsAdmin"/>
        <property name="gsearchServer" value="http://localhost:8080/fedoragsearch"/>
    </config>
    <init>
        <action name="logSetup" class="nl.mpi.tla.flat.deposit.action.WorkspaceLogSetup">
            <parameter name="dir" value="{$work}/logs"/>
        </action>        
        <action name="check workspace" class="nl.mpi.tla.flat.deposit.action.SIPLoad">
            <parameter name="sip" value="{$work}/metadata/record.cmdi"/>
        </action>
    </init>
    <main>
        <action name="assemble package" class="nl.mpi.tla.flat.deposit.action.PackageAssembly">
            <parameter name="dir" value="{$work}/resources"/>
            <parameter name="prefix" value="{$epicPrefix}"/>
        </action>
        <action name="validate metadata" class="nl.mpi.tla.flat.deposit.action.Validate">
            <parameter name="schemaCache" value="{$base}/cache/schemas"/>
            <parameter name="rules" value="{$base}/policies/rules.sch"/>
        </action>
        <action name="validate resources" class="nl.mpi.tla.flat.deposit.action.FITS">
        	<parameter name="fitsService" value="{$fitsService}"/>
        	<parameter name="mimetypes" value="{$base}/policies/fits-mimetypes.xml"/>
        </action>
        <!--
        <action name="quality assessment" class="nl.mpi.tla.flat.deposit.action.QualityAssessment"/>
        <action name="manual evaluation" class="nl.mpi.tla.flat.deposit.action.Evaluate"/>
        -->
        <action name="persist resources" class="nl.mpi.tla.flat.deposit.action.Persist">
            <parameter name="resourcesDir" value="{$work}/resources"/>
            <parameter name="policyFile" value="{$base}/policies/persistence-policy.xml"/>
            <parameter name="xpathDatasetName" value="replace(//*[name()='MdSelfLink'], 'hdl:{$epicPrefix}/','')"/>
        </action>
        <!--
        <action class="nl.mpi.tla.flat.deposit.action.Versions"/>
        -->
        <action class="nl.mpi.tla.flat.deposit.action.HandleAssignment">
            <parameter name="prefix" value="{$epicPrefix}"/>
        </action>
        <!--
        <action class="nl.mpi.tla.flat.deposit.action.Relate"/>
        -->
        <action class="nl.mpi.tla.flat.deposit.action.ACL">
            <parameter name="policy" value="{$work}/metadata/policy.n3"/>
            <parameter name="dir" value="{$work}/acl"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.CreateFOX">
            <parameter name="cmd2dc" value="{$base}/policies/cmd2dc.xsl"/>
            <parameter name="cmd2fox" value="{$base}/transforms/cmd2fox.xsl"/>
            <parameter name="dir" value="{$work}/fox"/>
            <parameter name="relations" value="{$base}/dummies/relations.xml"/>
            <parameter name="policies" value="{$work}/acl"/>
            <parameter name="policies" value="{$home}/policies"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.EasyBag">
            <parameter name="bags" value="{$easy}"/>
            <!-- FOX (to get DC from) needs to be available -->
            <parameter name="foxes" value="{$work}/fox"/>
            <parameter name="creator" value="{$base}/policies/easy-bag-creator.xml"/>
            <!-- 
            <parameter name="audience" value="..."/>
            <parameter name="accessRights" value="..."/>
            -->
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.Deposit">
            <parameter name="fedoraServer" value="{$fedoraServer}"/>
            <parameter name="fedoraUser" value="{$fedoraUser}"/>
            <parameter name="fedoraPassword" value="{$fedoraPassword}"/>
            <parameter name="dir" value="{$work}/fox"/>
            <parameter name="trustStore" value="/opt/jssecacerts"/>
            <parameter name="trustStorePass" value="changeit"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.EPICHandleCreation">
            <parameter name="fedoraServer" value="{$publicFedoraServer}"/>
            <parameter name="epicConfig" value="{$base}/policies/epic-config.xml"/>
            <parameter name="trustStore" value="/opt/jssecacerts"/>
            <parameter name="trustStorePass" value="changeit"/>
        </action>
        <action class="nl.mpi.tla.flat.deposit.action.Index">
            <parameter name="gsearchServer" value="{$gsearchServer}"/>
            <parameter name="gsearchUser" value="{$gsearchUser}"/>
            <parameter name="gsearchPassword" value="{$gsearchPassword}"/>
        </action>
        <!--
        <action class="nl.mpi.tla.flat.deposit.action.WorkspaceCleanup"/>
        -->        
    </main>
    <exception>
        <!--
        <action name="log" class="nl.mpi.tla.flat.deposit.action.Log"/>
        -->
    </exception>
    <final>
        <action name="status" class="nl.mpi.tla.flat.deposit.action.UpdateSwordStatus">
            <parameter name="props" value="{$work}/../../deposit.properties"/>
        </action>
        <action name="logTeardown" class="nl.mpi.tla.flat.deposit.action.WorkspaceLogCleanup"/>        
    </final>
</flow>
